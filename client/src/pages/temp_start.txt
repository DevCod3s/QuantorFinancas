/**
 * @fileoverview Página de gestão financeira do sistema Quantor
 * 
 * Renomeada de "Transações" para "Finanças" com funcionalidades avançadas:
 * - Sistema de 4 abas principais: Visão Geral, Movimentações, Contas, Centro de Custo
 * - Sub-abas inteligentes com barra de progressão animada
 * - Gráficos avançados com Chart.js (linha, rosca, barras)
 * - Controles temporais completos (navegação, calendário, filtros de período)
 * - Dashboard visual de fluxo de caixa
 * - Demonstrativo diário com dados tabulares
 * - Centro de custo com categorização e barras de progresso
 * - Design responsivo e profissional
 * - Dados demonstrativos baseados em referências visuais
 * 
 * @author Equipe Quantor
 * @version 1.0.0
 */

// Importações React
import { useState, useEffect, useRef } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { apiRequest } from '../lib/queryClient';

// Importações de ícones Lucide
import { Plus, Edit, Trash2, Search, Filter, Eye, TrendingUp, TrendingDown, DollarSign, CreditCard, Building, Target, Activity, FileText, Clock, CheckCircle, Calendar, Settings, ChevronLeft, ChevronRight, Save, X, ChevronDown, ChevronRight as ChevronRightIcon, ArrowUpDown, Download, AlertTriangle, Building2 } from "lucide-react";

// Importações Material-UI
import TextField from '@mui/material/TextField';
import MenuItem from '@mui/material/MenuItem';
import FormControl from '@mui/material/FormControl';
import InputLabel from '@mui/material/InputLabel';
import Select from '@mui/material/Select';

// Importações de componentes UI
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { SubTabs } from "@/components/SubTabs";

// Importações de tipos
import { Transaction } from "@shared/schema";
import { ChartOfAccountsTree, ChartOfAccountNode, SAMPLE_CHART_OF_ACCOUNTS } from "@/types/ChartOfAccountsTree";
import { FloatingInput, FloatingSelect } from "@/components/ui/floating-input";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@/components/ui/popover";
import { Calendar as CalendarComponent } from "@/components/ui/calendar";
import { format } from "date-fns";
import { ptBR } from "date-fns/locale";
import { useSuccessDialog } from "@/components/ui/success-dialog";
import { useErrorDialog } from "@/components/ui/error-dialog";
import { useConfirmDialog } from "@/components/ui/confirm-dialog";
import { TransactionCard } from "@/components/TransactionCard";
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  ArcElement,
  BarElement,
  Title,
  Tooltip,
  Legend,
} from 'chart.js';
import { Line, Doughnut, Bar } from 'react-chartjs-2';

ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  ArcElement,
  BarElement,
  Title,
  Tooltip,
  Legend
);

export function Transactions() {
  const queryClient = useQueryClient();
  const { showSuccess, SuccessDialog } = useSuccessDialog();
  const { showError, ErrorDialog } = useErrorDialog();
  const { showConfirm, ConfirmDialog } = useConfirmDialog();
  
  const [searchTerm, setSearchTerm] = useState("");
  const [filterType, setFilterType] = useState<"all" | "income" | "expense">("all");
  const [activeTab, setActiveTab] = useState("visao-geral");
  const [progressWidth, setProgressWidth] = useState(0);
  const tabListRef = useRef<HTMLDivElement>(null);
  const [currentMonth, setCurrentMonth] = useState("julho 2025");
  const [selectedDate, setSelectedDate] = useState<Date | undefined>(new Date());
  const [filterPeriod, setFilterPeriod] = useState("Mensal");
  const [isCalendarOpen, setIsCalendarOpen] = useState(false);
  const [chartAccountModalOpen, setChartAccountModalOpen] = useState(false);
  const [bankAccountModalOpen, setBankAccountModalOpen] = useState(false);
  const [modalMode, setModalMode] = useState<'create' | 'edit' | 'view'>('create');
  const [editingAccount, setEditingAccount] = useState<any>(null);
  const [formData, setFormData] = useState({
    tipo: '',
    nome: '',
    categoria: '',
    subcategoria: '',
    incluirComo: ''
  });
  const [bankAccountData, setBankAccountData] = useState({
    initialBalanceDate: new Date().toISOString().split('T')[0],
    currentBalance: '',
    balanceType: 'credor',
    accountType: 'conta_corrente',
    name: '',
    currency: 'BRL',
    bank: '',
    agency: '',
    accountNumber: '',
    creditLimit: '',
    contactName: '',
    contactPhone: ''
  });

  // Mutation para criar conta bancária
  const createBankAccountMutation = useMutation({
    mutationFn: (bankAccountData: any) => 
      fetch('/api/bank-accounts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(bankAccountData),
      }).then(res => res.json()),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/bank-accounts'] });
      showSuccess('Conta bancária criada com sucesso!');
      setBankAccountModalOpen(false);
      setBankAccountData({
        initialBalanceDate: new Date().toISOString().split('T')[0],
        currentBalance: '',
        balanceType: 'credor',
        accountType: 'conta_corrente',
        name: '',
        currency: 'BRL',
        bank: '',
        agency: '',
        accountNumber: '',
        creditLimit: '',
        contactName: '',
        contactPhone: ''
      });
    },
    onError: (error: any) => {
      showError('Erro ao criar conta bancária', error.message || 'Verifique os dados e tente novamente.');
    }
  });

  // Handler para salvar conta bancária
  const handleBankAccountSave = async () => {
    if (!bankAccountData.name) {
      showError('Campo obrigatório', 'O nome da conta é obrigatório.');
      return;
    }

    if (!bankAccountData.currentBalance) {
      showError('Campo obrigatório', 'O saldo inicial é obrigatório.');
      return;
    }

    if (!bankAccountData.bank) {
      showError('Campo obrigatório', 'O banco é obrigatório.');
      return;
    }

    try {
      await createBankAccountMutation.mutateAsync(bankAccountData);
    } catch (error) {
      console.error('Erro ao salvar conta bancária:', error);
    }
  };




  
  // Estados para controle de ordenação e paginação
  const [payablesSortField, setPayablesSortField] = useState<string>('');
  const [payablesSortDirection, setPayablesSortDirection] = useState<'asc' | 'desc'>('asc');
  const [payablesCurrentPage, setPayablesCurrentPage] = useState(1);
  const [payablesItemsPerPage] = useState(10);
  
  const [receivablesSortField, setReceivablesSortField] = useState<string>('');
  const [receivablesSortDirection, setReceivablesSortDirection] = useState<'asc' | 'desc'>('asc');
  const [receivablesCurrentPage, setReceivablesCurrentPage] = useState(1);
  const [receivablesItemsPerPage] = useState(10);
  
  // Estado para modal de transação
  const [transactionModalOpen, setTransactionModalOpen] = useState(false);
  const [newTransactions, setNewTransactions] = useState<any[]>([]);
  
  // Dados mockados para À Pagar
  const payablesData = [
    { id: 1, company: 'Banco Santander', cnpj: '90.400.888/0001-42', dueDate: '10/01/2025', product: 'Cartão de Crédito', type: 'Parcela', status: 'Vencida', value: 280.00 },
    { id: 2, company: 'Imobiliária Santos', cnpj: '12.345.678/0001-90', dueDate: '05/02/2025', product: 'Aluguel Comercial', type: 'Mensal', status: 'Pendente', value: 1200.00 },
    { id: 3, company: 'Caixa Econômica Federal', cnpj: '00.360.305/0001-04', dueDate: '15/02/2025', product: 'Financiamento Imóvel', type: 'Parcela', status: 'Em dia', value: 485.00 },
    { id: 4, company: 'Companhia Energética de GO', cnpj: '01.628.539/0001-73', dueDate: '20/02/2025', product: 'Energia Elétrica', type: 'Mensal', status: 'Em dia', value: 125.00 },
    { id: 5, company: 'Telefonia Ltda', cnpj: '98.765.432/0001-10', dueDate: '22/02/2025', product: 'Telefone Comercial', type: 'Mensal', status: 'Em dia', value: 75.00 }
  ];
  
  // Dados mockados para À Receber
  const receivablesData = [
    { id: 1, company: 'Empresa ABC Ltda', cnpj: '33.222.111/0001-55', dueDate: '15/01/2025', product: 'Salário', type: 'Mensal', status: 'Confirmado', value: 3500.00 },
    { id: 2, company: 'Cliente XYZ Ltda', cnpj: '44.555.666/0001-77', dueDate: '22/01/2025', product: 'Projeto Freelance', type: 'Parcela', status: 'Pendente', value: 450.00 },
    { id: 3, company: 'Banco do Brasil', cnpj: '00.000.000/0001-91', dueDate: '30/01/2025', product: 'Rendimento Poupança', type: 'Rendimento', status: 'Automático', value: 25.30 },
    { id: 4, company: 'Nubank', cnpj: '18.236.120/0001-58', dueDate: '05/02/2025', product: 'Cashback Cartão', type: 'Cashback', status: 'Automático', value: 28.40 }
  ];
  
  // Funções de ordenação
  const handlePayablesSort = (field: string) => {
    const direction = payablesSortField === field && payablesSortDirection === 'asc' ? 'desc' : 'asc';
    setPayablesSortField(field);
    setPayablesSortDirection(direction);
  };
  
  const handleReceivablesSort = (field: string) => {
    const direction = receivablesSortField === field && receivablesSortDirection === 'asc' ? 'desc' : 'asc';
    setReceivablesSortField(field);
    setReceivablesSortDirection(direction);
  };
  
  // Função para ordenar dados
  const sortData = (data: any[], sortField: string, sortDirection: 'asc' | 'desc') => {
    if (!sortField) return data;
    
    return [...data].sort((a, b) => {
      let aVal = a[sortField];
      let bVal = b[sortField];
      
      // Tratamento especial para datas
      if (sortField === 'dueDate') {
        aVal = new Date(aVal.split('/').reverse().join('-'));
        bVal = new Date(bVal.split('/').reverse().join('-'));
      }
      
      // Tratamento especial para valores
      if (sortField === 'value') {
        aVal = parseFloat(aVal);
        bVal = parseFloat(bVal);
      }
      
      if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
      if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
      return 0;
    });
  };
  
  // Dados ordenados e paginados
  const sortedPayables = sortData(payablesData, payablesSortField, payablesSortDirection);
  const paginatedPayables = sortedPayables.slice(
    (payablesCurrentPage - 1) * payablesItemsPerPage,
    payablesCurrentPage * payablesItemsPerPage
  );
  
  const sortedReceivables = sortData(receivablesData, receivablesSortField, receivablesSortDirection);
  const paginatedReceivables = sortedReceivables.slice(
    (receivablesCurrentPage - 1) * receivablesItemsPerPage,
    receivablesCurrentPage * receivablesItemsPerPage
  );
  
  // Cálculos de paginação
  const payablesTotalPages = Math.ceil(sortedPayables.length / payablesItemsPerPage);
  const receivablesTotalPages = Math.ceil(sortedReceivables.length / receivablesItemsPerPage);

  // Query para buscar contas do plano de contas
  const { data: chartAccounts = [], isLoading: isLoadingAccounts, refetch: refetchAccounts } = useQuery({
    queryKey: ['/api/chart-accounts'],
    queryFn: () => fetch('/api/chart-accounts').then(res => res.json()),
  });

  // Query para buscar contas bancárias
  const { data: bankAccounts = [], isLoading: isLoadingBankAccounts, refetch: refetchBankAccounts } = useQuery({
    queryKey: ['/api/bank-accounts'],
    queryFn: () => fetch('/api/bank-accounts', { credentials: 'include' }).then(res => res.json()),
  });

  // Garantir que chartAccounts seja sempre um array e seja um tipo correto
  const safeChartAccountsData: any[] = Array.isArray(chartAccounts) ? chartAccounts : [];

  // Função para salvar nova transação
  const handleSaveTransaction = (transactionData: any) => {
    const newTransaction = {
      id: Date.now(), // ID temporário
      company: transactionData.conta,
      cnpj: '00.000.000/0001-00', // Valor de exemplo
      dueDate: transactionData.data,
      product: transactionData.descricao || 'Lançamento',
      type: transactionData.repeticao,
      status: 'Pendente',
      value: transactionData.valorNumerico
    };

    // Adicionar à lista correta baseado no tipo
    if (transactionData.tipo === 'Receita') {
      // Adicionar aos recebíveis
      receivablesData.push(newTransaction);
      showSuccess('Receita adicionada com sucesso!');
    } else if (transactionData.tipo === 'Despesa') {
      // Adicionar aos pagáveis
      payablesData.push(newTransaction);
      showSuccess('Despesa adicionada com sucesso!');
    }

    setNewTransactions(prev => [...prev, newTransaction]);
  };

  // Mutation para criar conta
  const createAccountMutation = useMutation({
    mutationFn: (accountData: any) => 
      fetch('/api/chart-accounts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(accountData)
      }).then(res => res.json()),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/chart-accounts'] });
      showSuccess('Conta criada com sucesso!');
      setChartAccountModalOpen(false);
      resetForm();
    },
    onError: (error: any) => {
      showError('Erro ao criar conta', error.message || 'Erro ao criar conta');
    }
  });

  // Mutation para atualizar conta
  const updateAccountMutation = useMutation({
    mutationFn: ({ id, data }: { id: number; data: any }) => 
      fetch(`/api/chart-accounts/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).then(res => res.json()),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['/api/chart-accounts'] });
      showSuccess('Conta atualizada com sucesso!');
      setChartAccountModalOpen(false);
      resetForm();
    },
    onError: (error: any) => {
      showError('Erro ao atualizar conta', error.message || 'Erro ao atualizar conta');
    }
  });

  // Mutation para excluir conta
  const deleteAccountMutation = useMutation({
    mutationFn: (id: number) => 
      fetch(`/api/chart-accounts/${id}`, { method: 'DELETE' }),
    onSuccess: (data, variables, context) => {
      queryClient.invalidateQueries({ queryKey: ['/api/chart-accounts'] });
    }
  });



  // Funções auxiliares para gerenciar o modal
  const resetForm = () => {
    setFormData({
      tipo: '',
      nome: '',
      categoria: '',
      subcategoria: '',
      incluirComo: ''
    });
    setEditingAccount(null);
    setModalMode('create');
  };

  const openCreateModal = () => {
    resetForm();
    setModalMode('create');
    setChartAccountModalOpen(true);
  };

  const openEditModal = (account: any) => {
    setFormData({
      tipo: account.type || '',
      nome: account.name || '',
      categoria: account.category || '',
      subcategoria: account.subcategory || '',
      incluirComo: account.parentId ? account.parentId.toString() : ''
    });
    setEditingAccount(account);
    setModalMode('edit');
    setChartAccountModalOpen(true);
  };

  const openViewModal = (account: any) => {
    setFormData({
      tipo: account.type || '',
      nome: account.name || '',
      categoria: account.category || '',
      subcategoria: account.subcategory || '',
      incluirComo: account.parentId ? account.parentId.toString() : ''
    });
    setEditingAccount(account);
    setModalMode('view');
    setChartAccountModalOpen(true);
  };

  const handleDeleteAccount = (account: any) => {
    if (window.confirm(`Tem certeza que deseja excluir a conta "${account.name}"?`)) {
      deleteAccountMutation.mutate(account.id);
    }
  };

  // Função para salvar conta (criar ou editar)
